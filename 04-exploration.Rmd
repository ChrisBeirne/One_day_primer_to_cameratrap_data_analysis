```{r, echo=F, results='hide', message =F, warning=F}
# Check you have them and load them
list.of.packages <- c("kableExtra", "tidyr", "leaflet", "dplyr", "viridis", "corrplot", "lubridate", "plotly")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)

```


# Analysis data exploration {#exploration}
In the error checking section we focused our 'data exploration' on figures which would help us find errors, now we want to shift gears and create plots which actually tell us about our final, independent data.

All of the data we will be analysing from this point onwards will come from the `data/processed_data/` folder!

## Final locations plot

So lets read in the `camera_locations.csv` and plot the final survey locations in leaflet:

```{r}
locs <- read.csv("data/processed_data/AlgarRestorationProject_camera_locations.csv")
head(locs)
# If you want to colour by a category do it here:
category <- "feature_type"
# First lets choose a category to colour
locs[,category] <- factor(locs[,category])
col.cat <- turbo(length(levels(locs[,category])))
# Add it to the dataframe
locs$colours <- col.cat[locs[,category]]

m <- leaflet() %>%
  # Add a satellite image layer
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  
  addProviderTiles(providers$Esri.WorldTopoMap, group="Base") %>%     
  addCircleMarkers(lng=locs$longitude, lat=locs$latitude,
                   # Colour the markers depending on the 'feature type'
                   color=locs$colours,
                   # Add a popup of the deployment code 
                   popup=paste(locs$placename, locs[,category])) %>%
  # Add a legend explaining what is going on
  addLegend("bottomleft", colors = col.cat,  labels = levels(locs[,category]),
    title = category,
    labFormat = labelFormat(prefix = "$"),
    opacity = 1
  ) %>%
  # add a layer control box to toggle between the layers
  addLayersControl(
    baseGroups = c("Satellite", "Base"),
    options = layersControlOptions(collapsed = FALSE)
  )
m

```

## Independent detections summary

When you are writing papers based on camera data, you often put a summary table in the appendix. We will use the species list we created to append summary information as we go. This also allows us to create plots with common names very easily!

```{r}
# Also read in the species list
sp_summary <- read.csv("data/processed_data/AlgarRestorationProject_species_list.csv", header=T)

```

### Total number of captures
To summarise the wildlife detections in this project we can make use of the `total_observations.csv` files:

```{r}
total_obs <- read.csv("data/processed_data/AlgarRestorationProject_30min_independent_total_observations.csv", header=T)

```

The format of the output tables is what we would call 'wide' we have the values for differnt species as columns. This format is sometimes useful, other times we might want a "longer" format where every observation a unique species_site combination. We can do this using the 'pivot_longer' function:

```{r}

long_obs <- total_obs %>% 
  pivot_longer(cols=sp_summary$sp, names_to="sp", values_to = "count") # Takes the species names columns, and makes them unique rows with "sp" as the key 

# We can them summarise those using dplyr
tmp <- long_obs %>% group_by(sp) %>% summarise(count=sum(count))

sp_summary <- left_join(sp_summary, tmp)

```


### Raw occupancy
We can very quickly flip a count to a presence absence using `as.logical` this converts and intergers to 1 and keeps 0's as 0!  

```{r}
# we can very 
total_binary <-  total_obs %>% mutate(across(sp_summary$sp, ~+as.logical(.x)))

```

Now when we do the same calculations as before, we can calculate the number of sites occupied:

```{r}
long_bin <- total_binary %>% 
  pivot_longer(cols=sp_summary$sp, names_to="sp", values_to = "count") # Takes the species names columns, and makes them unique rows with "sp" as the key 

# We can them summarise those using dplyr - this time dividing by the number of locations
tmp <- long_bin %>% group_by(sp) %>% summarise(occupancy=sum(count)/nrow(locs))

# add the results to the sp_summary
sp_summary <- left_join(sp_summary, tmp)

```

### Comparison plot

Then we can use the dataframe created above to summaries the detections and the occupancy patterns.

```{r}
# Lets put the dataframes in a sensible order
sp_summary <- sp_summary[order(sp_summary$count),]

yform <- list(categoryorder = "array",
              categoryarray = sp_summary$common_name#,
#             tickfont = list(size = 7),
)
xform <- list(title="Captures")

# Capture rate
fig1 <- plot_ly(x = sp_summary$count, y = sp_summary$common_name, type = 'bar', orientation = 'h') %>% 
 layout(yaxis = yform, xaxis=xform)

yform <- list(categoryorder = "array",
              categoryarray = sp_summary$common_name,
              showticklabels=F)
xform <- list(title="Occupancy")


# Occupancy
fig2 <- plot_ly(x = sp_summary$occupancy, y = sp_summary$common_name, type = 'bar', orientation = 'h') %>% 
 layout(yaxis = yform, xaxis=xform)

subplot(fig1, fig2, titleX = T)

```

## Temporal patterns in capture rates

Next lets summarise the temporal patterns in the number of sites (placenames) surveyed, and the total number of animals captured. We will use the monthly dataframes in order to do this, but you could do it at the weekly or daily scale if required!

```{r}
mon_obs <- read.csv("data/processed_data/AlgarRestorationProject_30min_independent_monthly_observations.csv", header=T)

```

```{r}

# Count up the number of stations and the number of camera nights
mon_summary <- mon_obs %>% group_by(date) %>% summarise(locs_active=n(), cam_days=sum(days))

# Add in the species specific counts
mon_summary <- mon_obs %>% group_by(date) %>%  
  summarise(across(sp_summary$sp, sum, na.rm=TRUE)) %>% 
  left_join(x=mon_summary)

```

Now lets use lubridate to create a date object and plot the output

```{r}
# Lets make each mon
mon_summary$date <- ym(mon_summary$date)

par(mfrow=c(1,2))

plot(mon_summary$date, mon_summary$locs_active,
     type="l", ylim=c(0, max(mon_summary$locs_active)),
     las=1, ylab="Number of cameras active", xlab="Date",
     )
points(mon_summary$date, mon_summary$locs_active, pch=19)


mon_summary$all.sp <- rowSums(mon_summary[, sp_summary$sp])

plot(mon_summary$date, mon_summary$all.sp/(mon_summary$cam_days/100),
     type="l", 
     las=1, ylab="Detections per 100 cam days", xlab="Date")
points(mon_summary$date, mon_summary$all.sp/(mon_summary$cam_days/100), pch=19)


```

## Species specific capture rates
```{r}
par(mfrow=c(2,2))
i <- 1
for(i in 1:length(sp_summary$sp))
{
  plot(mon_summary$date, pull(mon_summary, sp_summary$sp[i])/(mon_summary$cam_days/100),  # The pull commmand allows you to grab a specific column in a dataframe and turn it into a vector!
     type="l", 
     las=1, ylab="Detections per 100 cam days", xlab="Date",
     main=sp_summary$sp[i])
points(mon_summary$date, pull(mon_summary, sp_summary$sp[i])/(mon_summary$cam_days/100), pch=19)
  
}
```

Can you see any interesting patterns in here?

## Spatial patterns in capture rates
We also often want to explore if there are any spatial patterns in capture rates, these can hint at any ecological relationships we might want to explore further. Here we do it for just a single species, the white-tiled deer. 

Here we make use of the 'total_obs' data frame we imported earlier. We also use the 'locs' dataframe.

```{r}

total_obs <- left_join(total_obs, locs)

focal_species <- "Odocoileus.virginianus"

focal_cr <- pull(total_obs, focal_species)/(total_obs$days/100)

m <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldTopoMap, group="Base") %>%     
  addCircleMarkers(lng=locs$longitude, lat=locs$latitude,
                   # Add a popup of the deployment code 
                   popup=paste(locs$placename),
                   radius=(focal_cr/max(focal_cr)*10)+1, stroke=F,
                   fillOpacity=0.6) 
m

```


Try it for some different species. Can you see any different patterns?

## Species co-occurences

Camera trap data are being increasingly used to model multiple species communties. We can use the `corrplot` package (ADD LINK TO VINGNETTE) to explore the co-occurrence patterns of the species in the community. 

The plot below uses the 'total_obs' dataframe, and performs pairwise correlations between the species on the left, and the species on the top row. Blue colours mean that at locations where you have high counts of one species, you also have high counts of the paired species. Red colours mean if you have high counts of one species, then you are likely to have low counts of the species pair (or vice-versa).

We implement a more nuanced form of this data analysis in **A LATER CHAPTER**



```{r}

par(mfrow=c(1,1))
tmp <- total_obs[, sp_summary$sp]
tmp <- tmp[colSums(tmp)>5]
M <- cor(tmp)

corrplot(M, method="color", #col=matrix(col(200)),
         type="upper", order="hclust",
         #addCoef.col = "black", # Add codepicient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         #p.mat = p.mat, sig.level = 0.01, insig = "blank",
         # hide correlation codepicient on the principal diagonal
         diag=FALSE
         )
```


## Covariate plots


**CHRIS** DO SOME EXAMPLE BIVARIATE CORRELATIONS






